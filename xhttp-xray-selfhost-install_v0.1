#!/bin/bash
set -euo pipefail

# Перед запуском:
# export domain=vash-domen.tld
if [[ -z "${domain:-}" ]]; then
  echo "ERROR: domain не задан. Сделай: export domain=vash-domen.tld"
  exit 1
fi

echo "Установка: Xray (VLESS + XHTTP) за Nginx (TLS на домене: $domain)"
sleep 2

apt update
apt install -y curl wget nginx qrencode jq openssl

# --------------------------
# 1) Получаем TLS сертификат (acme.sh) как в твоём selfsni-скрипте
# --------------------------
wget -O - https://get.acme.sh | sh
~/.acme.sh/acme.sh --upgrade --auto-upgrade

# Для HTTP-01 нужен доступ к /var/www/html по 80 порту
mkdir -p /var/www/html
echo "ok" > /var/www/html/index.html
systemctl enable --now nginx

~/.acme.sh/acme.sh --issue --server letsencrypt -d "$domain" -w /var/www/html --keylength ec-256 --force

mkdir -p /usr/local/etc/xray/xray_cert/
~/.acme.sh/acme.sh --install-cert -d "$domain" --ecc \
  --fullchain-file /usr/local/etc/xray/xray_cert/xray.crt \
  --key-file       /usr/local/etc/xray/xray_cert/xray.key
chmod +r /usr/local/etc/xray/xray_cert/xray.key

# Скрипт обновления сертификата + рестарт nginx/xray
cat > /usr/local/etc/xray/xray_cert/xray-cert-renew <<EOF
#!/bin/bash
/root/.acme.sh/acme.sh --install-cert -d "$domain" --ecc \
  --fullchain-file /usr/local/etc/xray/xray_cert/xray.crt \
  --key-file       /usr/local/etc/xray/xray_cert/xray.key
chmod +r /usr/local/etc/xray/xray_cert/xray.key
systemctl restart nginx
systemctl restart xray
EOF
chmod +x /usr/local/etc/xray/xray_cert/xray-cert-renew

crontab -l | grep -q "xray-cert-renew" || (crontab -l; echo "0 3 1 * * bash /usr/local/etc/xray/xray_cert/xray-cert-renew") | crontab -

# --------------------------
# 2) Включаем BBR (как у тебя)
# --------------------------
bbr=$(sysctl -a | grep net.ipv4.tcp_congestion_control || true)
if [[ "$bbr" == "net.ipv4.tcp_congestion_control = bbr" ]]; then
  echo "bbr уже включен"
else
  echo "net.core.default_qdisc=fq" >> /etc/sysctl.conf
  echo "net.ipv4.tcp_congestion_control=bbr" >> /etc/sysctl.conf
  sysctl -p
  echo "bbr включен"
fi

# --------------------------
# 3) Устанавливаем Xray-core
# --------------------------
bash -c "$(curl -4 -L https://github.com/XTLS/Xray-install/raw/main/install-release.sh)" @ install

# --------------------------
# 4) Генерируем ключи/параметры
# --------------------------
rm -f /usr/local/etc/xray/.keys
touch /usr/local/etc/xray/.keys

UUID="$(xray uuid)"
# Скрытый путь под XHTTP (лучше не "/")
XHTTP_PATH="/$(openssl rand -hex 8)/"
SOCKET="/dev/shm/xrxh.socket"

{
  echo "uuid: $UUID"
  echo "domain: $domain"
  echo "xhttp_path: $XHTTP_PATH"
  echo "socket: $SOCKET"
} >> /usr/local/etc/xray/.keys

# --------------------------
# 5) Конфиг Xray: VLESS over XHTTP, БЕЗ TLS (TLS делает nginx)
#    Xray слушает unix-socket, nginx прокидывает grpc_pass
# --------------------------
cat > /usr/local/etc/xray/config.json <<EOF
{
  "log": { "loglevel": "warning" },
  "dns": {
    "servers": [
      "https+local://1.1.1.1/dns-query",
      "localhost"
    ]
  },
  "routing": {
    "domainStrategy": "IPIfNonMatch",
    "rules": [
      {
        "type": "field",
        "domain": ["geosite:category-ads-all"],
        "outboundTag": "block"
      }
    ]
  },
  "inbounds": [
    {
      "tag": "vless-xhttp",
      "listen": "${SOCKET},0666",
      "protocol": "vless",
      "settings": {
        "clients": [
          { "email": "main", "id": "${UUID}", "flow": "" }
        ],
        "decryption": "none"
      },
      "streamSettings": {
        "network": "xhttp",
        "security": "none",
        "xhttpSettings": {
          "mode": "auto",
          "path": "${XHTTP_PATH}"
        }
      },
      "sniffing": {
        "enabled": true,
        "destOverride": ["http", "tls", "quic"]
      }
    }
  ],
  "outbounds": [
    { "protocol": "freedom", "tag": "direct" },
    { "protocol": "blackhole", "tag": "block" }
  ],
  "policy": {
    "levels": {
      "0": { "handshake": 3, "connIdle": 180 }
    }
  }
}
EOF

# --------------------------
# 6) Nginx: реальный сайт + TLS на 443 + прокид XHTTP по path через grpc_pass
# --------------------------
cat > /etc/nginx/sites-available/default <<EOF
server {
  listen 80;
  server_name ${domain};
  location /.well-known/acme-challenge/ { root /var/www/html; }
  location / { return 301 https://\$host\$request_uri; }
}

server {
  listen 443 ssl http2;
  server_name ${domain};

  ssl_certificate     /usr/local/etc/xray/xray_cert/xray.crt;
  ssl_certificate_key /usr/local/etc/xray/xray_cert/xray.key;

  ssl_protocols TLSv1.2 TLSv1.3;
  ssl_prefer_server_ciphers off;

  root /var/www/html;
  index index.html;

  # XHTTP (VLESS) endpoint
  location ${XHTTP_PATH} {
    client_max_body_size 0;
    grpc_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
    grpc_set_header Host \$host;

    client_body_timeout 5m;
    grpc_read_timeout 315;
    grpc_send_timeout 5m;

    grpc_pass unix:${SOCKET};
  }

  add_header Strict-Transport-Security "max-age=63072000" always;
}
EOF

nginx -t
systemctl restart nginx
systemctl enable --now xray
systemctl restart xray

# --------------------------
# 7) Утилиты: mainuser/newuser/rmuser/sharelink/userlist (как в твоих скриптах)
# --------------------------
cat > /usr/local/bin/userlist <<'EOF'
#!/bin/bash
emails=($(jq -r '.inbounds[0].settings.clients[].email' "/usr/local/etc/xray/config.json"))
if [[ ${#emails[@]} -eq 0 ]]; then
  echo "Список клиентов пуст"
  exit 1
fi
echo "Список клиентов:"
for i in "${!emails[@]}"; do
  echo "$((i+1)). ${emails[$i]}"
done
EOF
chmod +x /usr/local/bin/userlist

cat > /usr/local/bin/mainuser <<'EOF'
#!/bin/bash
protocol="vless"
port="443"
uuid=$(awk -F': ' '/^uuid:/ {print $2}' /usr/local/etc/xray/.keys)
domain=$(awk -F': ' '/^domain:/ {print $2}' /usr/local/etc/xray/.keys)
path=$(awk -F': ' '/^xhttp_path:/ {print $2}' /usr/local/etc/xray/.keys)

# В клиентских ссылках XHTTP обычно используют TLS с доменом (TLS терминирует nginx),
# а path совпадает с nginx location и xhttpSettings.path на сервере.
link="$protocol://$uuid@$domain:$port?security=tls&type=xhttp&path=$(python3 - <<PY
import urllib.parse; print(urllib.parse.quote("""$path"""))
PY
)&host=$domain&sni=$domain&alpn=h2,http/1.1&fp=chrome&encryption=none#mainuser"

echo ""
echo "Ссылка для подключения:"
echo "$link"
echo ""
echo "QR-код:"
echo "$link" | qrencode -t ansiutf8
EOF
chmod +x /usr/local/bin/mainuser

cat > /usr/local/bin/newuser <<'EOF'
#!/bin/bash
read -p "Введите имя пользователя (email): " email
if [[ -z "$email" || "$email" == *" "* ]]; then
  echo "Имя пользователя не может быть пустым или содержать пробелы."
  exit 1
fi

user_json=$(jq --arg email "$email" '.inbounds[0].settings.clients[] | select(.email == $email)' /usr/local/etc/xray/config.json)
if [[ -n "$user_json" ]]; then
  echo "Пользователь с таким именем уже существует."
  exit 1
fi

uuid=$(xray uuid)
jq --arg email "$email" --arg uuid "$uuid" \
  '.inbounds[0].settings.clients += [{"email": $email, "id": $uuid, "flow": ""}]' \
  /usr/local/etc/xray/config.json > /tmp/xray_tmp.json && mv /tmp/xray_tmp.json /usr/local/etc/xray/config.json

systemctl restart xray

protocol="vless"
port="443"
domain=$(awk -F': ' '/^domain:/ {print $2}' /usr/local/etc/xray/.keys)
path=$(awk -F': ' '/^xhttp_path:/ {print $2}' /usr/local/etc/xray/.keys)

link="$protocol://$uuid@$domain:$port?security=tls&type=xhttp&path=$(python3 - <<PY
import urllib.parse; print(urllib.parse.quote("""$path"""))
PY
)&host=$domain&sni=$domain&alpn=h2,http/1.1&fp=chrome&encryption=none#$email"

echo ""
echo "Ссылка для подключения:"
echo "$link"
echo ""
echo "QR-код:"
echo "$link" | qrencode -t ansiutf8
EOF
chmod +x /usr/local/bin/newuser

cat > /usr/local/bin/rmuser <<'EOF'
#!/bin/bash
emails=($(jq -r '.inbounds[0].settings.clients[].email' "/usr/local/etc/xray/config.json"))
if [[ ${#emails[@]} -eq 0 ]]; then
  echo "Нет клиентов для удаления."
  exit 1
fi

echo "Список клиентов:"
for i in "${!emails[@]}"; do
  echo "$((i+1)). ${emails[$i]}"
done

read -p "Введите номер клиента для удаления: " choice
if ! [[ "$choice" =~ ^[0-9]+$ ]] || (( choice < 1 || choice > ${#emails[@]} )); then
  echo "Ошибка: номер должен быть от 1 до ${#emails[@]}"
  exit 1
fi

selected_email="${emails[$((choice - 1))]}"

jq --arg email "$selected_email" \
  '(.inbounds[0].settings.clients) |= map(select(.email != $email))' \
  "/usr/local/etc/xray/config.json" > /tmp/xray_tmp.json && mv /tmp/xray_tmp.json /usr/local/etc/xray/config.json

systemctl restart xray
echo "Клиент $selected_email удалён."
EOF
chmod +x /usr/local/bin/rmuser

cat > /usr/local/bin/sharelink <<'EOF'
#!/bin/bash
emails=($(jq -r '.inbounds[0].settings.clients[].email' /usr/local/etc/xray/config.json))
if [[ ${#emails[@]} -eq 0 ]]; then
  echo "Список клиентов пуст"
  exit 1
fi

for i in "${!emails[@]}"; do
  echo "$((i + 1)). ${emails[$i]}"
done

read -p "Выберите клиента: " client
if ! [[ "$client" =~ ^[0-9]+$ ]] || (( client < 1 || client > ${#emails[@]} )); then
  echo "Ошибка: номер должен быть от 1 до ${#emails[@]}"
  exit 1
fi

selected_email="${emails[$((client - 1))]}"
index=$(jq --arg email "$selected_email" '.inbounds[0].settings.clients | to_entries[] | select(.value.email == $email) | .key' /usr/local/etc/xray/config.json)

uuid=$(jq --argjson index "$index" -r '.inbounds[0].settings.clients[$index].id' /usr/local/etc/xray/config.json)
domain=$(awk -F': ' '/^domain:/ {print $2}' /usr/local/etc/xray/.keys)
path=$(awk -F': ' '/^xhttp_path:/ {print $2}' /usr/local/etc/xray/.keys)

link="vless://$uuid@$domain:443?security=tls&type=xhttp&path=$(python3 - <<PY
import urllib.parse; print(urllib.parse.quote("""$path"""))
PY
)&host=$domain&sni=$domain&alpn=h2,http/1.1&fp=chrome&encryption=none#$selected_email"

echo ""
echo "Ссылка для подключения:"
echo "$link"
echo ""
echo "QR-код:"
echo "$link" | qrencode -t ansiutf8
EOF
chmod +x /usr/local/bin/sharelink

# help-файл
cat > "$HOME/help" <<'EOF'
Команды для управления пользователями Xray:

  mainuser   - ссылка/QR основного пользователя
  newuser    - создать нового пользователя
  rmuser     - удалить пользователя
  sharelink  - выбрать пользователя и получить ссылку/QR
  userlist   - список клиентов

Полезное:
  systemctl restart xray
  systemctl restart nginx

Конфиги:
  /usr/local/etc/xray/config.json
  /etc/nginx/sites-available/default
EOF

echo ""
echo "ГОТОВО: Xray-core установлен (VLESS + XHTTP за Nginx TLS)."
echo "Открой: https://$domain (должна открываться твоя заглушка/сайт)"
echo ""
mainuser